name: NeoLoad docker
on: workflow_dispatch
env:
  TEST_NAME: '"NeoloadPOC"'
  WORKSPACE_NAME: '"Evolution"'
  VERSION: '9.2.1'
  NEOLOADWEB_URL: 'https://neoload-api.saas.neotys.com/'
  NEOLOADWEB_TOKEN: ${{ secrets.NEOLOADWEB_TOKEN }}
  NEOLOADWEB_ZONE: ${{ secrets.NEOLOADWEB_ZONE }}
  NEOLOADWEB_LG_COUNT: '2'
  NEOLOADWEB_CONTROLLER_IMAGE: 'neotys/neoload-controller:9.2.1'
  NEOLOADWEB_LG_IMAGE: 'neotys/neoload-loadgenerator:9.2.1'

jobs:
  run_test_neoload_poc:
    permissions: write-all
    outputs:
      output1: ${{ steps.Run_test.outputs.test }}
    name: Run Neoload POC
    runs-on: ubuntu-latest

    steps:
    
      - name: Checkout
        uses: actions/checkout@v3
        
        
      - name: "Install NeoLoad CLI"
        run: |
          pip3 install -U neoload
          neoload docker install
        
      - name: "NeoLoad Login"
        run: neoload login --url ${{ env.NEOLOADWEB_URL}} --workspace ${{ env.WORKSPACE_NAME }} ${{ env.NEOLOADWEB_TOKEN }}
        
      - name: "Set agents and controllers"
        run: |
          neoload config set docker.lg.default_count=${{ env.NEOLOADWEB_LG_COUNT }}
          neoload config set docker.zone=${{ env.NEOLOADWEB_ZONE }}
          neoload config set docker.controller.image=${{ env.NEOLOADWEB_CONTROLLER_IMAGE }}
          neoload config set docker.lg.image=${{ env.NEOLOADWEB_LG_IMAGE }}
          neoload docker up
        
      - name: "NeoLoad run test"
        id: Run_test
        run: >
          neoload run 
          --external-url $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID 
          --external-url-label "Github Action Run ${{ env.VERSION }}.$GITHUB_RUN_NUMBER" 
          --name "Docker Test - Github build ${{ env.VERSION }}.$GITHUB_RUN_NUMBER" 
          --description "Neoload POC Docker" 
          ${{ env.TEST_NAME }} | head -n 1 | sed -r 's/^.{14}//' >> "$GITHUB_OUTPUT"
          
      - name: "echo run test"
        run:  echo "$GITHUB_OUTPUT"
        
      - name: "Generate Test Report"
        if: always()
        run: neoload test-results junitsla

      - name: "Publish Test Report"
        if: always()
        uses: scacap/action-surefire-report@v1
        with:
          report_paths:  junit-sla.xml
          fail_on_test_failures: true
        
      - name: 'Upload Artifact'
        if: always()
        uses: actions/upload-artifact@v3
        with:
            name: performance_report
            path: junit-sla.xml
            retention-days: 5

